apiVersion: batch/v1
kind: CronJob
metadata:
  name: garbage-collector
  labels:
    app: foxglove-garbage-collector
spec:
  schedule: "*/10 * * * *" # every 10 minutes
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  successfulJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
            - name: cloud-credentials
              secret:
                secretName: gcp-cloud-credential
                optional: true
          containers:
            - name: garbage-collector
              image: us-central1-docker.pkg.dev/foxglove-images/images/garbage-collector:dcb5b4812e4d0a6054638ea43712f2e7ee5050ab
              volumeMounts:
                - mountPath: /secrets
                  name: cloud-credentials
              envFrom:
                - secretRef:
                    name: cloud-credentials
                    optional: true
              env:
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: /secrets/credential.json
                - name: FOXGLOVE_API_URL
                  value: "{{ .Values.globals.foxgloveApiUrl }}"
                - name: FOXGLOVE_SITE_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: foxglove-site
                      key: token
                      optional: false
                - name: MODE
                  value: self-managed
                - name: STORAGE_PROVIDER
                  value: "{{ .Values.primarySite.lake.storageProvider }}"
                - name: STORAGE_AZURE_STORAGE_ACCOUNT_NAME
                  value: "{{ .Values.primarySite.azure.storageAccountName }}"
                - name: STORAGE_AZURE_SERVICE_URL
                  value: "{{ .Values.primarySite.azure.serviceUrl }}"
          serviceAccountName: garbage-collector
          restartPolicy: OnFailure
